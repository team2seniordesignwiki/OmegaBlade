// Mp3.c
//
#include <built_in.h>
#include "Mp3.h"

// MP3 Connections
//
sbit MP3_CS                    at LATB4_bit;
sbit MP3_RST                   at LATH0_bit;
sbit DREQ                      at RH7_bit;
sbit BSYNC                     at LATB5_bit;
sbit DCLK                      at LATH3_bit;
sbit SDATA                     at LATD2_bit;

sbit MP3_CS_Direction          at TRISB4_bit;
sbit MP3_RST_Direction         at TRISH0_bit;
sbit DREQ_Direction            at TRISH7_bit;
sbit BSYNC_Direction           at TRISB5_bit;
sbit DCLK_Direction            at TRISH3_bit;
sbit SDATA_Direction           at TRISD2_bit;

// VS1011E constants
//
const char WRITE_CODE  = 0x02;
const char READ_CODE   = 0x03;
const char MODE_ADDR   = 0x00;
const char CLOCKF_ADDR = 0x03;
const char VOL_ADDR    = 0x0B;
const char DECODE_TIME = 0x04;

char data_buffer_32[32];

#define CODE_SIZE 980

const unsigned char atab[CODE_SIZE] = { /* Register addresses */
    0x7, 0x6, 0x6, 0x6, 0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x7, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x7, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6, 0x6,
    0x6, 0x6, 0x6, 0xA
};
const unsigned int dtab[CODE_SIZE] = { /* Data to write */
    0x8050, 0x2800, 0x2f40, 0x0000, 0x0024, 0x8052, 0x3e12, 0xb817,
    0x3e12, 0x3815, 0x3e05, 0xb814, 0x3615, 0x0024, 0x0000, 0x800a,
    0x3e10, 0x3801, 0x0001, 0xe000, 0x3e10, 0xb803, 0x0000, 0x0303,
    0x3e11, 0x3805, 0x3e11, 0xb807, 0x3e14, 0x3812, 0xb884, 0x130c,
    0x3410, 0x4024, 0x4112, 0x10d0, 0x4010, 0x008c, 0x4010, 0x0024,
    0xf400, 0x4012, 0x3000, 0x3840, 0x3009, 0x3801, 0x0000, 0x0041,
    0xfe02, 0x0024, 0x2900, 0x82c0, 0x48b2, 0x0024, 0x36f3, 0x0844,
    0x6306, 0x8845, 0xae3a, 0x8840, 0xbf8e, 0x8b41, 0xac32, 0xa846,
    0xffc8, 0xabc7, 0x3e01, 0x7800, 0xf400, 0x4480, 0x6090, 0x0024,
    0x6090, 0x0024, 0xf400, 0x4015, 0x3009, 0x3446, 0x3009, 0x37c7,
    0x3009, 0x1800, 0x3009, 0x3844, 0x48b3, 0xe1e0, 0x4882, 0x4040,
    0xfeca, 0x0024, 0x5ac2, 0x0024, 0x5a52, 0x0024, 0x4cc2, 0x0024,
    0x48ba, 0x4040, 0x4eea, 0x4801, 0x4eca, 0x9800, 0xff80, 0x1bc1,
    0xf1eb, 0xe3e2, 0xf1ea, 0x184c, 0x4c8b, 0xe5e4, 0x48be, 0x9804,
    0x488e, 0x41c6, 0xfe82, 0x0024, 0x5a8e, 0x0024, 0x525e, 0x1b85,
    0x4ffe, 0x0024, 0x48b6, 0x41c6, 0x4dd6, 0x48c7, 0x4df6, 0x0024,
    0xf1d6, 0x0024, 0xf1d6, 0x0024, 0x4eda, 0x0024, 0x0000, 0x0fc3,
    0x2900, 0x82c0, 0x4e82, 0x0024, 0x4084, 0x130c, 0x0004, 0xe100,
    0x3440, 0x4024, 0x4010, 0x0024, 0xf400, 0x4012, 0x3200, 0x4024,
    0xb132, 0x0024, 0x4214, 0x0024, 0xf224, 0x0024, 0x6230, 0x0024,
    0x0001, 0x0001, 0x2800, 0x28c9, 0x0000, 0x0024, 0xf400, 0x40c2,
    0x3200, 0x0024, 0xff82, 0x0024, 0x48b2, 0x0024, 0xb130, 0x0024,
    0x6202, 0x0024, 0x003f, 0xf001, 0x2800, 0x2bd1, 0x0000, 0x1046,
    0xfe64, 0x0024, 0x48be, 0x0024, 0x2800, 0x2cc0, 0x3a01, 0x8024,
    0x3200, 0x0024, 0xb010, 0x0024, 0xc020, 0x0024, 0x3a00, 0x0024,
    0x36f4, 0x1812, 0x36f1, 0x9807, 0x36f1, 0x1805, 0x36f0, 0x9803,
    0x36f0, 0x1801, 0x3405, 0x9014, 0x36f3, 0x0024, 0x36f2, 0x1815,
    0x2000, 0x0000, 0x36f2, 0x9817, 0x80bd, 0x3613, 0x0024, 0x3e12,
    0xb817, 0x3e12, 0x3815, 0x3e05, 0xb814, 0x3645, 0x0024, 0x0000,
    0x800a, 0x3e10, 0xb803, 0x0000, 0x0242, 0x3e11, 0x3805, 0x3e11,
    0xb807, 0x3e14, 0x7812, 0x3e14, 0xf80d, 0x3e03, 0xf80e, 0x6124,
    0x0024, 0x0030, 0x01d2, 0x2800, 0x3595, 0x4182, 0x0024, 0x3204,
    0x4024, 0x3100, 0x8024, 0x0030, 0x03d1, 0x3900, 0x8024, 0x3200,
    0x8024, 0x6294, 0x0024, 0x2800, 0x7000, 0x3a00, 0x8024, 0x3613,
    0x0024, 0x2800, 0x3885, 0x0004, 0xe6d2, 0x0004, 0xe051, 0x0000,
    0x2fd2, 0x3100, 0x8803, 0x6238, 0x1bcc, 0x0000, 0x0024, 0x2800,
    0x4e85, 0x4194, 0x0024, 0x0004, 0xe6d2, 0x3613, 0x0024, 0x0000,
    0x0302, 0x0004, 0xe011, 0x3009, 0x3850, 0x0004, 0xe010, 0x3009,
    0x3840, 0x0000, 0x1800, 0x2900, 0x8480, 0xb882, 0xb801, 0x0001,
    0xe010, 0x0000, 0x1700, 0x2900, 0x8780, 0xb882, 0x0024, 0x3900,
    0x9bc1, 0x0000, 0x2fd1, 0x3009, 0x1bc0, 0x3009, 0x1bd0, 0x3009,
    0x0404, 0x0004, 0xe051, 0x2800, 0x3e40, 0x3901, 0x0024, 0x4448,
    0x0402, 0x4294, 0x0024, 0x6498, 0x2402, 0x001f, 0x4002, 0x6424,
    0x0024, 0x0004, 0xe011, 0x2800, 0x3d91, 0x0000, 0x058e, 0x2400,
    0x4dce, 0x0000, 0x0013, 0x0004, 0xe051, 0x0004, 0xfa04, 0x3100,
    0x8024, 0xf224, 0x44c5, 0x4458, 0x0024, 0xf400, 0x4115, 0x3500,
    0xc024, 0x623c, 0x0024, 0x0000, 0x0024, 0x2800, 0x4e11, 0x0000,
    0x0024, 0x4384, 0x184c, 0x3100, 0x3800, 0x291b, 0xef80, 0xf200,
    0x0024, 0x003f, 0xfec3, 0x4084, 0x4491, 0x3113, 0x1bc0, 0xa234,
    0x0024, 0x0000, 0x2003, 0x6236, 0x2402, 0x0000, 0x1003, 0x2800,
    0x4748, 0x0000, 0x0024, 0x003f, 0xf803, 0x3100, 0x8024, 0xb236,
    0x0024, 0x2800, 0x4d40, 0x3900, 0xc024, 0x6236, 0x0024, 0x0000,
    0x0803, 0x2800, 0x4988, 0x0000, 0x0024, 0x003f, 0xfe03, 0x3100,
    0x8024, 0xb236, 0x0024, 0x2800, 0x4d40, 0x3900, 0xc024, 0x6236,
    0x0024, 0x0000, 0x0403, 0x2800, 0x4bc8, 0x0000, 0x0024, 0x003f,
    0xff03, 0x3100, 0x8024, 0xb236, 0x0024, 0x2800, 0x4d40, 0x3900,
    0xc024, 0x6236, 0x0402, 0x003f, 0xff83, 0x2800, 0x4d48, 0x0000,
    0x0024, 0xb236, 0x0024, 0x3900, 0xc024, 0xb884, 0x07cc, 0x3900,
    0x88cc, 0x3313, 0x0024, 0x0004, 0xe091, 0x4194, 0x2413, 0x0004,
    0xe0d1, 0x2800, 0x7015, 0x0004, 0xe6c2, 0x3423, 0x0024, 0x3c10,
    0x8024, 0x3100, 0xc024, 0x4304, 0x0024, 0x39f0, 0x8024, 0x3100,
    0x8024, 0x3cf0, 0x8024, 0x0004, 0xe6c2, 0xb884, 0x33c2, 0x3c20,
    0x8024, 0x34d0, 0xc024, 0x6238, 0x0024, 0x0000, 0x0024, 0x2800,
    0x6698, 0x4396, 0x0024, 0x2400, 0x6643, 0x0000, 0x0024, 0x3423,
    0x0024, 0x34e4, 0x4024, 0x3123, 0x0024, 0x3100, 0xc024, 0x4304,
    0x0024, 0x4284, 0x2402, 0x0001, 0xe002, 0x2800, 0x6449, 0x0000,
    0x0024, 0x3613, 0x104c, 0x3004, 0xb850, 0x4088, 0x1043, 0x4336,
    0x1390, 0x4234, 0x0024, 0x4234, 0x0024, 0x0000, 0x2003, 0x2900,
    0x72c0, 0xf400, 0x4091, 0x3423, 0x1bd0, 0x3404, 0x4024, 0x3113,
    0x0024, 0x3100, 0x8024, 0x6236, 0x0024, 0x0004, 0x0003, 0x2800,
    0x5c58, 0x0000, 0x0024, 0x0000, 0x03c4, 0x4396, 0x844c, 0xb248,
    0x0402, 0xfe08, 0x0024, 0x48be, 0x0024, 0x4264, 0x4184, 0xb234,
    0x0024, 0x0004, 0x0003, 0x3900, 0x8024, 0x3404, 0x4024, 0x3123,
    0x0024, 0x3100, 0x8024, 0x6236, 0x0024, 0x0000, 0x4003, 0x2800,
    0x5e88, 0x0000, 0x0024, 0xb884, 0x878c, 0x3900, 0x8024, 0x34e4,
    0x4024, 0x3123, 0x0024, 0x31e0, 0x8024, 0x6236, 0x0402, 0x0000,
    0x0024, 0x2800, 0x6448, 0x4284, 0x0024, 0x0000, 0x0024, 0x2800,
    0x6455, 0x0000, 0x0024, 0x3413, 0x184c, 0x3410, 0x8024, 0x3e10,
    0x8024, 0x34e0, 0xc024, 0x2900, 0x1480, 0x3e10, 0xc024, 0xf400,
    0x40d1, 0x003f, 0xff44, 0x36e3, 0x048c, 0x3100, 0x8024, 0xfe44,
    0x0024, 0x48ba, 0x0024, 0x3901, 0x0024, 0x0000, 0x00c3, 0x3423,
    0x0024, 0xf400, 0x4511, 0x34e0, 0x8024, 0x4234, 0x0024, 0x39f0,
    0x8024, 0x3100, 0x8024, 0x6294, 0x0024, 0x3900, 0x8024, 0x0004,
    0xe011, 0x6894, 0x04c3, 0xa234, 0x0403, 0x6238, 0x0024, 0x0000,
    0x0024, 0x2800, 0x7001, 0x0000, 0x0024, 0xb884, 0x90cc, 0x39f0,
    0x8024, 0x3100, 0x8024, 0xb884, 0x3382, 0x3c20, 0x8024, 0x34d0,
    0xc024, 0x6238, 0x0024, 0x0004, 0xe112, 0x2800, 0x7018, 0x4396,
    0x0024, 0x2400, 0x6fc3, 0x0000, 0x0024, 0x0003, 0xf002, 0x3201,
    0x0024, 0xb424, 0x0024, 0x0028, 0x0002, 0x2800, 0x6ec5, 0x6246,
    0x0024, 0x0004, 0x0003, 0x2800, 0x6e81, 0x4434, 0x0024, 0x0000,
    0x1003, 0x6434, 0x0024, 0x2800, 0x6ec0, 0x3a00, 0x8024, 0x3a00,
    0x8024, 0x3213, 0x104c, 0xf400, 0x4511, 0x34f0, 0x8024, 0x6294,
    0x0024, 0x3900, 0x8024, 0x36f3, 0xd80e, 0x36f4, 0xd80d, 0x36f4,
    0x5812, 0x36f1, 0x9807, 0x36f1, 0x1805, 0x36f0, 0x9803, 0x3405,
    0x9014, 0x36f3, 0x0024, 0x36f2, 0x1815, 0x2000, 0x0000, 0x36f2,
    0x9817, 0x13e8, 0x0032, 0x004f, 0x007e, 0x00c8, 0x013d, 0x01f8,
    0x0320, 0x04f6, 0x07e0, 0x0c80, 0x13d8, 0x1f7f, 0x3200, 0x4f5f,
    0x61a8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x81cb, 0x3e12, 0xb814, 0x0000, 0x800a, 0x3e10, 0x3801,
    0x3e10, 0xb803, 0x3e11, 0x7806, 0x3e11, 0xf813, 0x3e13, 0xf80e,
    0x3e13, 0x4024, 0x3e04, 0x7810, 0x449a, 0x0040, 0x0000, 0x0803,
    0x2800, 0x7d44, 0x30f0, 0x4024, 0x0fff, 0xfec2, 0xa020, 0x0024,
    0x0fff, 0xff02, 0xa122, 0x0024, 0x4036, 0x0024, 0x0000, 0x1fc2,
    0xb326, 0x0024, 0x0010, 0x4002, 0x4326, 0x4495, 0x4024, 0x40d2,
    0x0000, 0x0180, 0xa100, 0x4090, 0x0010, 0x0042, 0x4204, 0x0024,
    0xbc82, 0x4091, 0x459a, 0x0024, 0x0000, 0x0054, 0x2800, 0x7c44,
    0xbd86, 0x4093, 0x2400, 0x7c05, 0xfe01, 0x5e0c, 0x5c43, 0x5f2d,
    0x5e46, 0x0024, 0x5c56, 0x0024, 0x5e53, 0x5e0c, 0x5c43, 0x5f2d,
    0x5e46, 0x0024, 0x5c56, 0x0024, 0x5e52, 0x0024, 0x4cb2, 0x4405,
    0x0010, 0x4004, 0x654a, 0x9810, 0x0000, 0x0144, 0xa54a, 0x1bd1,
    0x0004, 0xe013, 0x3301, 0xc444, 0x687e, 0x2005, 0xad76, 0x8445,
    0x4ed6, 0x8784, 0x36f3, 0x64c2, 0xac72, 0x8785, 0x4ec2, 0xa443,
    0x3009, 0x2440, 0x3009, 0x2741, 0x36f3, 0xd80e, 0x36f1, 0xd813,
    0x36f1, 0x5806, 0x36f0, 0x9803, 0x36f0, 0x1801, 0x2000, 0x0000,
    0x36f2, 0x9814, 0x820b, 0x4c82, 0x0024, 0x0000, 0x0024, 0x2000,
    0x0005, 0xf5c2, 0x0024, 0x0000, 0x0980, 0x2000, 0x0000, 0x6010,
    0x0024, 0x8212, 0x4080, 0x184c, 0x3e03, 0x784f, 0x2800, 0x8685,
    0x3e03, 0xb810, 0x4090, 0x0024, 0x2400, 0x8640, 0x0000, 0x0024,
    0x3810, 0x4024, 0x36f3, 0x9810, 0x36f3, 0x580f, 0x2000, 0x0000,
    0x0000, 0x0024, 0x821e, 0x4080, 0x184c, 0x3e03, 0x784f, 0x2800,
    0x8985, 0x3e03, 0xb810, 0x4090, 0x0024, 0x2400, 0x8940, 0x0000,
    0x0024, 0x3009, 0x2041, 0x36f3, 0x9810, 0x36f3, 0x580f, 0x2000,
    0x0000, 0x0000, 0x0024, 0x0050
};

// Initialize VS1011e
//
void MP3_Init()
{

  DCLK_Direction  = 0;
  SDATA_Direction = 0;
  DCLK  = 0;
  SDATA = 0;

  MP3_CS_Direction  = 0;
  MP3_CS            = 1;
  MP3_RST_Direction = 0;
  MP3_RST           = 1;

  DREQ_Direction  = 1;
  BSYNC_Direction = 0;
  BSYNC           = 0;

}

// Load Spectrum Plugin
//
void MP3_LoadSpectrumPlugin()
{
  int i;

  for (i=0;i<CODE_SIZE;i++)
  {
    MP3_SCI_Write(atab[i], dtab[i]);
  }
  MP3_SCI_Write(0x07, 0x1381);
  MP3_SCI_Write(0x06, 0);
}

//
// Software Reset
//
void MP3_Soft_Reset(char fill_zeros)
{

  char i;

  MP3_SCI_Write(MODE_ADDR,0x0204);

  Delay_us(2);
  while (DREQ == 0);
  if (fill_zeros)
  {
    for (i=0; i<32; i++) 
    {
      data_buffer_32[i] = 0;
    }
    for (i=0; i < 2048/32; i++) 
    {
      MP3_SDI_Write_32(data_buffer_32);
    }
  }
  else
    MP3_SDI_Write(0);

}

// Set clock
//
void MP3_Set_Clock(unsigned int clock_khz, char doubler)
{

  clock_khz /= 2;
  if (doubler) 
  {
    clock_khz |= 0x8000;
  }
  MP3_SCI_Write(CLOCKF_ADDR, clock_khz);
  
}

// Set volume
//
void MP3_Set_Volume(char left,char right) 
{

  unsigned int volume;

  volume = (left<<8) + right;
  MP3_SCI_Write(VOL_ADDR, volume);

}

// Reset VS10011e
//
void MP3_Reset(char volume)
{
  MP3_Soft_Reset(0);
  MP3_Set_Clock(25000,0);
  MP3_Set_Volume(volume,volume);
  MP3_LoadSpectrumPlugin();

}

// SPI Write
//
void SW_SPI_Write(char data_)
{
  BSYNC = 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  BSYNC = 0;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
  SDATA = data_;
  DCLK = 1;
  data_ >>= 1;

  DCLK = 0;
}

// Writes one word to MP3 SCI
//
void MP3_SCI_Write(char address, unsigned int data_in) 
{

  MP3_CS = 0;
  SPI1_Write(WRITE_CODE);
  SPI1_Write(address);
  SPI1_Write(Hi(data_in));
  SPI1_Write(Lo(data_in));
  MP3_CS = 1;

  while (DREQ == 0);

}

// Reads words_count words from MP3 SCI
//
void MP3_SCI_Read(char start_address, char words_count, unsigned int *data_buffer) 
{

  unsigned int temp;

  MP3_CS = 0;
  
  SPI1_Write(READ_CODE);
  SPI1_Write(start_address);

  while (words_count--) 
  {
    temp = SPI1_Read(0);
    temp <<= 8;
    temp += SPI1_Read(0);
    *(data_buffer++) = temp;
  }
  MP3_CS = 1;
  
  while (DREQ == 0);

}

// Write one byte to MP3 SDI
//
void MP3_SDI_Write(char data_) 
{

  while (DREQ == 0);
  SW_SPI_Write(data_);
  
}

// Write 32 bytes to MP3 SDI
//
void MP3_SDI_Write_32(char *data_) 
{
  char i;

  while (DREQ == 0);
  
  for (i=0; i<32; i++)
    SW_SPI_Write(data_[i]);
    
}

// Read Elapsed Time
//
void MP3_Read_Time(unsigned int* seconds)
{
  MP3_SCI_Read(DECODE_TIME, 1, seconds);
}